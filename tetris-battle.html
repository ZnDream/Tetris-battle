<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris Battle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #faf5ff;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            grid-template-rows: repeat(20, 30px);
            gap: 1px;
            background-color: #f5f5f5;
            padding: 5px;
            border-radius: 10px;
            border: 3px solid #e3ddff;
        }
        
        .cell {
            background-color: #e3ddff;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .filled {
            background-color: #8B5cf6;
            color: #e3ddff;
        }
        
        .status {
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #7e41ba;
        }
        
        .controls {
            margin-bottom: 20px;
            font-size: 16px;
            color: #7e41ba;
        }
        
        .reset-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #FF5722;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .reset-btn:hover {
            background-color: #E64A19;
        }  
        
        .title {
            color: #7e41ba;
        }

        .currentPosition {
            background-color: #dbc4a3;
            color: white;
        }
    </style>
</head>
<body>
    <h1 class="title">Tetris Battle</h1>
    <div class="status" id="status">Score: 0</div>
    <div class="controls">Use arrow keys to move, the 'up' key to rotate, and 'space' to make the piece drop instantly.</div>
    <div class="game-board" id="board"></div>
    <br>
    <button class="reset-btn" onclick="resetGame()">Reset Game</button>

    <script>
        // 2D array to represent the game board (20 rows x 10 columns)
        let board = [];

        // Tetris pieces represented as 2D arrays
        let Ipiece = [[1, 1, 1, 1]];

        let Opiece = [
            [1, 1],
            [1, 1]
        ];

        let Tpiece = [
            [0, 1, 0],
            [1, 1, 1]
        ];

        let Lpiece = [
            [0, 0, 1],
            [1, 1, 1]
        ];

        // Current piece and its position
        let currentPiece = Ipiece;
        let pieceX = 4;
        let pieceY = 0;
        let cellElements = [];
        let score = 0; 
        let gameActive = true;
        // Game speed and interval (a bit too fast hahaha)
        const GAME_SPEED = 300;
        let gameInterval;

        function moveDown(){
            pieceY++;
        }

        function initBoard() {
            board = [];
            for (let row = 0; row < 20; row++) {
                board[row] = [];
                for (let col = 0; col < 10; col++) {
                    board[row][col] = 0;
                }
            }
            updateDisplay();
        }

        // Update the visual display
        function updateDisplay() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            
            cellElements = []; // Reset cellElements
            
            // Create all cells and store them in 2D array
            for (let row = 0; row < 20; row++) {
                cellElements[row] = []; 
                
                for (let col = 0; col < 10; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    boardElement.appendChild(cell);
                    cellElements[row][col] = cell;
                }
            }
            
            // Render locked pieces from the board
            for (let row = 0; row < 20; row++) {
                for (let col = 0; col < 10; col++) {
                    if (board[row][col] === 1) {
                        cellElements[row][col].className += ' filled';
                        cellElements[row][col].textContent = '';
                    }
                }
            }
            
            // Render current falling piece
            for (let row = 0; row < currentPiece.length; row++) {
                for (let col = 0; col < currentPiece[row].length; col++) {
                    if (currentPiece[row][col] === 1) {
                        const boardRow = pieceY + row;
                        const boardCol = pieceX + col;
                        
                        if (boardRow >= 0 && boardRow < 20 && boardCol >= 0 && boardCol < 10) {
                            cellElements[boardRow][boardCol].className += ' currentPosition';
                            cellElements[boardRow][boardCol].textContent = '';
                        }
                    }
                }
            }
        }

        function movePiece() {
            if (!gameActive) return;
            
            // Try to move down
            moveDown();
            
            // Check if the new position is valid
            if (checkCollision()) {
                // Collision detected! Move back up
                pieceY--;
                
                // Lock the piece into the board
                lockPiece();
                
                // Spawn a new piece
                spawnNewPiece();
                
                return;
            }
            
            updateDisplay();
        }

        function checkCollision() {
            // Loop through each block of the current piece
            for (let row = 0; row < currentPiece.length; row++) {
                for (let col = 0; col < currentPiece[row].length; col++) {
                    if (currentPiece[row][col] === 1) {
                        const boardRow = pieceY + row;
                        const boardCol = pieceX + col;
                        
                        // Check wall collision
                        if (boardRow < 0 || boardRow >= 20 || boardCol < 0 || boardCol >= 10) {
                            return true; // Collision!
                        }
                        
                        // Check collision with locked pieces
                        if (board[boardRow][boardCol] === 1) {
                            return true; // Collision!
                        }
                    }
                }
            }
            
            return false; // No collision
        }

        function lockPiece() {
            // Lock the current piece into the board array
            for (let row = 0; row < currentPiece.length; row++) {
                for (let col = 0; col < currentPiece[row].length; col++) {
                    if (currentPiece[row][col] === 1) {
                        const boardRow = pieceY + row;
                        const boardCol = pieceX + col;
                        
                        if (boardRow >= 0 && boardRow < 20 && boardCol >= 0 && boardCol < 10) {
                            board[boardRow][boardCol] = 1;
                        }
                    }
                }
            }
            
            // Check for completed rows
            clearRows();
        }

        function spawnNewPiece() {
            // Pick a random piece
            const pieces = [Ipiece, Opiece, Tpiece, Lpiece];
            currentPiece = pieces[Math.floor(Math.random() * pieces.length)];
            
            // Reset position to top-center
            pieceX = 4;
            pieceY = 0;
            
            // Check if the new piece immediately collides (game over)
            if (checkCollision()) {
                gameOver();
            }
        }

        function clearRows() {
            // Check each row from bottom to top
            for (let row = 19; row >= 0; row--) {
                let isComplete = true;
                
                for (let col = 0; col < 10; col++) {
                    if (board[row][col] === 0) {
                        isComplete = false;
                        break;
                    }
                }
                
                if (isComplete) {
                    // Remove this row
                    board.splice(row, 1);
                    // Add a new empty row at the top
                    board.unshift(Array(10).fill(0));
                    // Increment score
                    score += 100;
                    document.getElementById('status').textContent = `Score: ${score}`;
                    // Check this row again since we shifted everything down
                    row++;
                }
            }
        }

        function rotatePiece() {
            if (!gameActive) return;
            
            // Create a rotated version of the piece
            const rotated = [];
            const rows = currentPiece.length;
            const cols = currentPiece[0].length;
            
            // Rotate 90 degrees clockwise
            for (let col = 0; col < cols; col++) {
                rotated[col] = [];
                for (let row = rows - 1; row >= 0; row--) {
                    rotated[col].push(currentPiece[row][col]);
                }
            }
            
            // Save the old piece in case rotation fails
            const oldPiece = currentPiece;
            currentPiece = rotated;
            
            // Check if rotation is valid
            if (checkCollision()) {
                // Rotation failed, revert
                currentPiece = oldPiece;
            }
            
            updateDisplay();
        }

        function space() {
            if (!gameActive) return;
            
            // Keep moving down until collision
            while (!checkCollision()) {
                pieceY++;
            }
            
            // Move back up one step (we went too far)
            pieceY--;
            
            // Lock the piece
            lockPiece();
            
            // Spawn new piece
            spawnNewPiece();
            
            updateDisplay();
        }

        function gameOver() {
            gameActive = false;
            clearInterval(gameInterval);
            document.getElementById('status').textContent = `Game Over! Final Score: ${score}`;
        }

        function resetGame() {
            // Reset variables
            currentPiece = Ipiece;
            pieceX = 4;
            pieceY = 0;
            cellElements = [];
            score = 0; 
            gameActive = true;
            
            document.getElementById('status').textContent = 'Score: 0';
            
            clearInterval(gameInterval);
            initBoard();
            gameInterval = setInterval(movePiece, GAME_SPEED);
        }

        // Keyboard controls
        document.addEventListener('keydown', function(event){
            const key = event.key.toLowerCase();
            
            // Prevent default behavior for arrow keys and space
            if (key.startsWith('arrow') || key === ' ') {
                event.preventDefault();
            }
            
            if (key === 'arrowup') {
                rotatePiece();
            } else if (key === ' ') {
                space();
            } else if (key === 'arrowleft') {
                pieceX--;
                if (checkCollision()) {
                    pieceX++;
                }
                updateDisplay();
            } else if (key === 'arrowright') {
                pieceX++;
                if (checkCollision()) {
                    pieceX--;
                }
                updateDisplay();
            } else if (key === 'arrowdown') {
                movePiece();
            }
        });

        // Initialize the game
        initBoard();
        gameInterval = setInterval(movePiece, GAME_SPEED);
    </script>
    
</body>
</html>